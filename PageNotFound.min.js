/* ============================================================
   Akshat Network Hub – PageNotFound Engine (Ultra Safe Edition)
   File     : PageNotFound.js
   Purpose  : Centralized error detection & routing (False-positive safe)
   Author : Akshat Network Hub
   ============================================================ */

(function () {
  "use strict";

  /* ------------------------------------------------------------
     GLOBAL CONFIG (Learning Club Safe Mode)
     ------------------------------------------------------------ */
  const AKSHAT_SCHOOL = {
    waitTime: 18000, // extended for PDF / TrackerJS
    minTextLength: 100,
    maxWaitForNetwork: 25000,

    routes: {
      NOT_FOUND: "/LearningClub-Key-of-Success-Learning-Point/Error/404.htm",
      EMPTY: "/LearningClub-Key-of-Success-Learning-Point/Error/empty.htm",
      IFRAME: "/LearningClub-Key-of-Success-Learning-Point/Error/iframe.htm",
      BLOCKED: "/LearningClub-Key-of-Success-Learning-Point/Error/blocked.htm",
      OFFLINE: "/LearningClub-Key-of-Success-Learning-Point/Error/no-internet.htm",
      TIMEOUT: "/LearningClub-Key-of-Success-Learning-Point/Error/timeout.htm",
      PERMISSION: "/LearningClub-Key-of-Success-Learning-Point/Error/permission.htm",
      CORS: "/LearningClub-Key-of-Success-Learning-Point/Error/cors.htm",
      CSP: "/LearningClub-Key-of-Success-Learning-Point/Error/csp.htm",
      DNS: "/LearningClub-Key-of-Success-Learning-Point/Error/dns.htm",
      SERVER: "/LearningClub-Key-of-Success-Learning-Point/Error/server.htm",
      MAINTENANCE: "/LearningClub-Key-of-Success-Learning-Point/Error/maintenance.htm"
    }
  };

  /* ------------------------------------------------------------
     REDIRECT HANDLER (Family Router)
     ------------------------------------------------------------ */
  function prasadParivaarRedirect(type, reason) {
    const from = encodeURIComponent(
      window.location.pathname + window.location.search
    );
    const why = encodeURIComponent(reason || type);
    const target =
      AKSHAT_SCHOOL.routes[type] || AKSHAT_SCHOOL.routes.NOT_FOUND;

    window.location.replace(`${target}?from=${from}&reason=${why}`);
  }

  function rakshaTry(fn, fallback) {
    try { return fn(); } catch { return fallback; }
  }

  /* ------------------------------------------------------------
     SAFE CONTENT VALIDATION
     ------------------------------------------------------------ */
  function mathsHasMeaning() {
    const body = document.body;
    if (!body) return false;

    const text = body.innerText.replace(/\s+/g, " ").trim();

    const hasPdfCanvas = document.querySelector("canvas");
    const hasPdfJs = window.pdfjsLib || window["pdfjs-dist/build/pdf"];
    const hasTrackerUI =
      document.querySelector("[id*='akshat']") ||
      document.querySelector("[class*='tracker']");

    const semanticContent =
      document.querySelector("main") ||
      document.querySelector("section") ||
      document.querySelector("article");

    return (
      text.length >= AKSHAT_SCHOOL.minTextLength ||
      hasPdfCanvas ||
      hasPdfJs ||
      hasTrackerUI ||
      semanticContent
    );
  }

  /* ------------------------------------------------------------
     CONTEXT CHECKS (SOFT MODE)
     ------------------------------------------------------------ */
  function physicsIsEmbedded() {
    return rakshaTry(() => window.self !== window.top, false);
  }

  function chemistryIsEmpty() {
    return document.body && document.body.children.length === 0;
  }

  function geographyOffline() {
    return navigator.onLine === false;
  }

  function historyTimedOut(start) {
    return Date.now() - start > AKSHAT_SCHOOL.maxWaitForNetwork;
  }

  function economicsPermissionDenied() {
    return rakshaTry(() =>
      document.body?.innerText
        .toLowerCase()
        .includes("permission denied"), false);
  }

  function lawCSPBlocked() {
    return rakshaTry(() =>
      document.querySelector(
        "meta[http-equiv='Content-Security-Policy']"
      ) !== null, false);
  }

  function lawCORSBlocked() {
    return rakshaTry(() =>
      document.referrer &&
      new URL(document.referrer).origin !== window.location.origin, false);
  }

  function computerTitleInvalid() {
    const t = (document.title || "").toLowerCase();
    return t.includes("404") || t.includes("not found");
  }

  /* ------------------------------------------------------------
     FINAL DECISION ENGINE
     ------------------------------------------------------------ */
  const examStartTime = Date.now();

  function collegeFinalExam() {

    // 1. OFFLINE (hard)
    if (geographyOffline()) {
      prasadParivaarRedirect("OFFLINE", "no_internet");
      return;
    }

    // 2. BLANK DOM (hard)
    if (chemistryIsEmpty()) {
      prasadParivaarRedirect("EMPTY", "blank_dom");
      return;
    }

    // 3. TIMEOUT (only if no content)
    if (
      historyTimedOut(examStartTime) &&
      !mathsHasMeaning()
    ) {
      prasadParivaarRedirect("TIMEOUT", "load_timeout");
      return;
    }

    // 4. PERMISSION (content-based)
    if (economicsPermissionDenied()) {
      prasadParivaarRedirect("PERMISSION", "access_denied");
      return;
    }

    // 5. CSP / CORS (only if content missing)
    if (!mathsHasMeaning()) {
      if (lawCSPBlocked()) {
        prasadParivaarRedirect("CSP", "security_policy");
        return;
      }
      if (lawCORSBlocked()) {
        prasadParivaarRedirect("CORS", "cross_origin");
        return;
      }
    }

    // 6. IFRAME (only if blocked & empty)
    if (physicsIsEmbedded() && !mathsHasMeaning()) {
      prasadParivaarRedirect("IFRAME", "embedded_context");
      return;
    }

    // 7. TITLE SIGNAL (soft)
    if (computerTitleInvalid() && !mathsHasMeaning()) {
      prasadParivaarRedirect("NOT_FOUND", "title_signal");
      return;
    }

    // 8. FINAL CONTENT CHECK
    if (!mathsHasMeaning()) {
      prasadParivaarRedirect("EMPTY", "no_meaningful_content");
      return;
    }

    // PASS – VALID PAGE
  }

  /* ------------------------------------------------------------
     DELAYED EXAM BELL (SAFE FOR SPA + PDF)
     ------------------------------------------------------------ */
  setTimeout(collegeFinalExam, AKSHAT_SCHOOL.waitTime);

})();